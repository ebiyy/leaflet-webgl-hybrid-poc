# ADR-001: 地図レンダリング技術の選定

**日付**: 2025-06-12  
**ステータス**: 承認済み  
**決定者**: Leaflet WebGL Hybrid POC開発チーム  

## コンテキスト

Leaflet WebGL Hybrid POCでは、大量のオブジェクト（最大10,000個）を地図上に表示し、リアルタイムでアニメーションさせる必要がある。POCフェーズで複数のレンダリング技術を検証した。

## 検討した選択肢

### 1. Leaflet.js（DOM）
- **メリット**: シンプル、標準的な実装
- **デメリット**: 4,000オブジェクトが実用限界
- **結果**: ❌ 性能不足

### 2. Leaflet.js + Canvas
- **メリット**: 高性能、Leafletエコシステム活用可能
- **デメリット**: 特になし
- **結果**: ✅ 10,000オブジェクトで75FPS達成

### 3. Leaflet.js + Pixi.js（WebGL）
- **メリット**: 最高性能、将来の拡張性
- **デメリット**: 若干の実装複雑性
- **結果**: ✅ 10,000オブジェクトで75FPS達成

### 4. MapLibre GL JS
- **メリット**: 3D対応、ベクタータイル
- **デメリット**: 
  - オーバースペック（2Dゲームには不要）
  - バンドルサイズ増大
  - 学習コスト高
- **結果**: ❌ 検討除外

### 5. Mapbox GL JS
- **メリット**: MapLibre GLと同様
- **デメリット**: 
  - 有料ライセンス
  - オーバースペック
- **結果**: ❌ 検討除外

## 決定

**Leaflet.js + Canvas/WebGL（Pixi.js）** の組み合わせを採用する。

## 理由

1. **性能要件を満たす**
   - 目標60FPSに対して75FPS達成（125%）
   - 10,000オブジェクトを安定表示

2. **軽量性**
   - Leaflet.jsは軽量な2Dマップライブラリ
   - 必要に応じてCanvas/WebGLを選択可能
   - 全体のWASMサイズ172KB（Gzip）を維持

3. **実装のシンプルさ**
   - Leafletの標準的なAPIを活用
   - Canvas/WebGLレイヤーとして実装
   - 既存のエコシステムを活用可能

4. **将来の拡張性**
   - WebGLモードでパーティクルエフェクト可能
   - 必要に応じてシェーダー実装可能

## 結果

- 3つのレンダリングモードを実装（DOM/Canvas/WebGL）
- ユーザーが選択可能な設計
- パフォーマンス目標を大幅に上回る結果

## 参考資料

- [POC結果レポート](../reports/poc-results-report.md)
- [パフォーマンス比較レポート](../reports/performance-comparison-report.md)